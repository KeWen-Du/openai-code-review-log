### 代码变更记录 git diff
diff --git a/.github/workflows/main-maven-jar.yml b/.github/workflows/main-maven-jar.ymlindex 389e15f..09c23eb 100644--- a/.github/workflows/main-maven-jar.yml+++ b/.github/workflows/main-maven-jar.yml@@ -30,7 +30,44 @@ jobs:       - name: Copy openai-code-review-sdk JAR         run: mvn dependency:copy -Dartifact=dkw.middleware:openai-code-review-sdk:1.0 -DoutputDirectory=./libs +      - name: Get repository name+        id: repo-name+        run: echo "REPO_NAME=${GITHUB_REPOSITORY##*/}" >> $GITHUB_ENV++      - name: Get branch name+        id: branch-name+        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV++      - name: Get commit author+        id: commit-author+        run: echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an <%ae>')" >> $GITHUB_ENV++      - name: Get commit message+        id: commit-message+        run: echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV++      - name: Print repository, branch name, commit author, and commit message+        run: |+          echo "Repository name is ${{ env.REPO_NAME }}"+          echo "Branch name is ${{ env.BRANCH_NAME }}"+          echo "Commit author is ${{ env.COMMIT_AUTHOR }}"+          echo "Commit message is ${{ env.COMMIT_MESSAGE }}"  +       - name: Run Code Review         run: java -jar ./libs/openai-code-review-sdk-1.0.jar         env:-          GITHUB_TOKENS: ${{ secrets.CODE_TOKEN }}\ No newline at end of file+          # Github 配置；GITHUB_REVIEW_LOG_URI「https://github.com/xfg-studio-project/openai-code-review-log」、GITHUB_TOKEN「https://github.com/settings/tokens」+          GITHUB_REVIEW_LOG_URI: ${{ secrets.CODE_REVIEW_LOG_URI }}+          GITHUB_TOKENS: ${{ secrets.CODE_TOKEN }}+          COMMIT_PROJECT: ${{ env.REPO_NAME }}+          COMMIT_BRANCH: ${{ env.BRANCH_NAME }}+          COMMIT_AUTHOR: ${{ env.COMMIT_AUTHOR }}+          COMMIT_MESSAGE: ${{ env.COMMIT_MESSAGE }}+          # 微信配置 「https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index」+          WEIXIN_APPID: ${{ secrets.WEIXIN_APPID }}+          WEIXIN_SECRET: ${{ secrets.WEIXIN_SECRET }}+          WEIXIN_TOUSER: ${{ secrets.WEIXIN_TOUSER }}+          WEIXIN_TEMPLATE_ID: ${{ secrets.WEIXIN_TEMPLATE_ID }}+          # OpenAi - ChatGLM 配置「https://open.bigmodel.cn/api/paas/v4/chat/completions」、「https://open.bigmodel.cn/usercenter/apikeys」+          CHATGLM_APIHOST: ${{ secrets.CHATGLM_APIHOST }}+          CHATGLM_APIKEYSECRET: ${{ secrets.CHATGLM_APIKEYSECRET }}\ No newline at end of filediff --git a/openai-code-review-sdk/pom.xml b/openai-code-review-sdk/pom.xmlindex 82b376b..0b52646 100644--- a/openai-code-review-sdk/pom.xml+++ b/openai-code-review-sdk/pom.xml@@ -101,7 +101,7 @@                     <archive>                         <manifest>                             <addDefaultImplementationEntries>true</addDefaultImplementationEntries>-                            <mainClass>dkw.middleware.sdk.OpenAiCodeReview</mainClass>+                            <mainClass>dkw.middleware.sdk.OpenAiCodeReviewBak</mainClass>                         </manifest>                     </archive>                 </configuration>diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReview.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReview.javaindex 86260ff..39483f7 100644--- a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReview.java+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReview.java@@ -1,210 +1,73 @@ package dkw.middleware.sdk; -import com.alibaba.fastjson2.JSON;-import dkw.middleware.sdk.domain.model.ChatCompletionRequest;-import dkw.middleware.sdk.domain.model.ChatCompletionSyncResponse;-import dkw.middleware.sdk.domain.model.Message;-import dkw.middleware.sdk.domain.model.Model;-import dkw.middleware.sdk.types.utils.BearerTokenUtils;-import dkw.middleware.sdk.types.utils.WXAccessTokenUtils;-import org.eclipse.jgit.api.Git;-import org.eclipse.jgit.transport.UsernamePasswordCredentialsProvider;--import java.io.*;-import java.net.HttpURLConnection;-import java.net.URL;-import java.nio.charset.StandardCharsets;-import java.text.SimpleDateFormat;-import java.util.ArrayList;-import java.util.Date;-import java.util.Random;-import java.util.Scanner;+import dkw.middleware.sdk.domain.service.impl.OpenAiCodeReviewService;+import dkw.middleware.sdk.infrastructure.git.GitCommand;+import dkw.middleware.sdk.infrastructure.openai.IOpenAI;+import dkw.middleware.sdk.infrastructure.openai.impl.ChatGLM;+import dkw.middleware.sdk.infrastructure.weixin.WeiXin;+import org.slf4j.Logger;+import org.slf4j.LoggerFactory; -public class OpenAiCodeReview {-    public static void main(String[] args) throws Exception {-        System.out.println("openai代码评审 测试执行");--        String token = System.getenv("GITHUB_TOKENS");-        if (null == token || token.isEmpty()) {-            throw new RuntimeException("token is null");-        }-        //代码检出-        ProcessBuilder processBuilder = new ProcessBuilder("git", "diff", "HEAD~1", "HEAD");--        Process process = processBuilder.start();--        BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(process.getInputStream()));-        String line;--        StringBuffer diffCode = new StringBuffer();-        while ((line = bufferedReader.readLine()) != null) {-            diffCode.append(line);-        }--        int exitCode = process.waitFor();-        System.out.println("exit code=" + exitCode);-        System.out.println("diff code=\r\n" + diffCode);--        //代码评审-        String log = codeReview(diffCode.toString());-        System.out.println("code review log:\r\n" + log);--        //写入日志-        String logUrl = writeLog(token, log, diffCode.toString());-        System.out.println("write log to:\r\n" + logUrl);--        //消息通知-        System.out.println("pushMessage：" + logUrl);-        pushMessage(logUrl);--    } -    private static void pushMessage(String logUrl) {-        String accessToken = WXAccessTokenUtils.getAccessToken();-        System.out.println(accessToken);--        Message message = new Message();-        message.put("project", "openai-code-review-9139-dkw");-        message.put("review", logUrl);-        message.setUrl(logUrl);--        String url = String.format("https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=%s", accessToken);-        System.out.println(JSON.toJSONString(message));-        sendPostRequest(url, JSON.toJSONString(message));-    }--    private static void sendPostRequest(String urlString, String jsonBody) {-        try {-            URL url = new URL(urlString);-            HttpURLConnection conn = (HttpURLConnection) url.openConnection();-            conn.setRequestMethod("POST");-            conn.setRequestProperty("Content-Type", "application/json; utf-8");-            conn.setRequestProperty("Accept", "application/json");-            conn.setDoOutput(true);--            try (OutputStream os = conn.getOutputStream()) {-                byte[] input = jsonBody.getBytes(StandardCharsets.UTF_8);-                os.write(input, 0, input.length);-            }--            try (Scanner scanner = new Scanner(conn.getInputStream(), StandardCharsets.UTF_8.name())) {-                String response = scanner.useDelimiter("\\A").next();-                System.out.println(response);-            }-        } catch (Exception e) {-            e.printStackTrace();-        }-    }--    private static String codeReview(String diffCode) throws Exception {-        String ak = "8751544afb8b574a2d3a717bed8bf86e.NR9C8vqi6DIhbSJh";-        String token = BearerTokenUtils.getToken(ak);--        URL url = new URL("https://open.bigmodel.cn/api/paas/v4/chat/completions");-        HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();--        httpURLConnection.setRequestMethod("POST");-        httpURLConnection.setRequestProperty("Authorization", "Bearer " + token);-        httpURLConnection.setRequestProperty("Content-Type", "application/json");-        httpURLConnection.setRequestProperty("User-Agent", "Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)");-        httpURLConnection.setDoOutput(true);--        String jsonInpuString = "{"-                + "\"model\":\"glm-4-flash\","-                + "\"messages\": ["-                + "    {"-                + "        \"role\": \"user\","-                + "        \"content\": \"你是一个高级编程架构师，精通各类场景方案、架构设计和编程语言请，请您根据git diff记录，对代码做出评审。代码为: " + diffCode + "\""-                + "    }"-                + "]"-                + "}";--        ChatCompletionRequest chatCompletionRequest = new ChatCompletionRequest();-        chatCompletionRequest.setModel(Model.GLM_4_FLASH.getCode());-        chatCompletionRequest.setMessages(new ArrayList<ChatCompletionRequest.Prompt>() {-            private static final long serialVersionUID = -7988151926241837899L;--            {-                add(new ChatCompletionRequest.Prompt("user", "你是一个高级编程架构师，精通各类场景方案、架构设计和编程语言请，请您根据git diff记录，对代码做出评审。代码如下:"));-                add(new ChatCompletionRequest.Prompt("user", diffCode));-            }-        });--        try (OutputStream outputStream = httpURLConnection.getOutputStream()) {-            byte[] bytes = JSON.toJSONString(chatCompletionRequest).getBytes(StandardCharsets.UTF_8);-            outputStream.write(bytes);-        }+public class OpenAiCodeReview { -        int responseCode = httpURLConnection.getResponseCode();-        System.out.println(responseCode);-        String responseMessage = httpURLConnection.getResponseMessage();-        System.out.println(responseMessage);+    private static final Logger logger = LoggerFactory.getLogger(OpenAiCodeReview.class); -        BufferedReader in = new BufferedReader(new InputStreamReader(httpURLConnection.getInputStream()));-        String inputLine;+    //微信公众号配置+    private String weixin_appid = "wx9dd00a93658e2aec";+    private String weixin_secret = "8602bfa758a55062a71915223d2c20b6";+    private String weixin_user_token = "oavof6xGr7jIjnJ6PkO_9TGKnHD0";+    private String weixin_template_id = "HRXwDS1fSLMFEYEUTxDMPNEyn0ES3iWIF71qu90eoZI"; -        StringBuffer content = new StringBuffer();-        while ((inputLine = in.readLine()) != null) {-            content.append(inputLine);-        }+    //ChatGLM配置+    private String chatglm_appKeySecret = "8751544afb8b574a2d3a717bed8bf86e.NR9C8vqi6DIhbSJh";+    private String chatglm_apiHost = "https://open.bigmodel.cn/api/paas/v4/chat/completions"; -        in.close();-        httpURLConnection.disconnect();+    // Github 配置+    private String github_review_log_uri;+    private String github_token; -        System.out.println("评审结果：" + content.toString());+    // 工程配置 - 自动获取+    private String github_project;+    private String github_branch;+    private String github_author;  -        ChatCompletionSyncResponse response = JSON.parseObject(content.toString(), ChatCompletionSyncResponse.class);-        System.out.println(response.getChoices().get(0).getMessage().getContent());-        return response.getChoices().get(0).getMessage().getContent();-    }+    public static void main(String[] args) throws Exception {+        GitCommand gitCommand = new GitCommand(+                getEnv("GITHUB_REVIEW_LOG_URI"),+                getEnv("GITHUB_TOKEN"),+                getEnv("COMMIT_PROJECT"),+                getEnv("COMMIT_BRANCH"),+                getEnv("COMMIT_AUTHOR"),+                getEnv("COMMIT_MESSAGE")+        ); -    private static String writeLog(String token, String log, String diffCodeStr) throws Exception {+        /**+         * 项目：{{repo_name.DATA}} 分支：{{branch_name.DATA}} 作者：{{commit_author.DATA}} 说明：{{commit_message.DATA}}+         */+        WeiXin weiXin = new WeiXin(+                getEnv("WEIXIN_APPID"),+                getEnv("WEIXIN_SECRET"),+                getEnv("WEIXIN_TOUSER"),+                getEnv("WEIXIN_TEMPLATE_ID")+        ); -        Git gitRepo = Git.cloneRepository()-                .setURI("https://github.com/KeWen-Du/openai-code-review-log.git")-                .setDirectory(new File("repo"))-                .setCredentialsProvider(new UsernamePasswordCredentialsProvider(token, ""))-                .call(); -        String dateFolderName = new SimpleDateFormat("yyyy-MM-dd").format(new Date());-        File dateFolder = new File("repo/" + dateFolderName);-        if (!dateFolder.exists()) {-            dateFolder.mkdirs();-        }-        String fileNameStr = generateRandomString(12) + ".md";-        String fileNamePre = new SimpleDateFormat("HH_mm_ss").format(new Date());-        String fileName = fileNamePre + "_" + fileNameStr;-        File newFile = new File(dateFolder, fileName);--        try (FileWriter writer = new FileWriter(newFile)) {-            writer.write("### 代码变更记录 git diff\r\n");-            writer.write(diffCodeStr + "\r\n\r\n");-            writer.write(log);-        } -        gitRepo.add().addFilepattern(dateFolderName + "/" + fileName).call();-        gitRepo.commit().setMessage("Add new file via GitHub Actions").call();-        gitRepo.push().setCredentialsProvider(new UsernamePasswordCredentialsProvider(token, "")).call();+        IOpenAI openAI = new ChatGLM(getEnv("CHATGLM_APIHOST"), getEnv("CHATGLM_APIKEYSECRET")); -        System.out.println("Changes have been pushed to the repository.");+        OpenAiCodeReviewService openAiCodeReviewService = new OpenAiCodeReviewService(gitCommand, openAI, weiXin);+        openAiCodeReviewService.exec(); -        return "https://github.com/KeWen-Du/openai-code-review-log/blob/master/" + dateFolderName + "/" + fileName;+        logger.info("openai-code-review done!");     } -    /**-     * 生成指定长度的随机字符-     *-     * @param length-     * @return-     */-    private static String generateRandomString(int length) {-        String characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";-        Random random = new Random();-        StringBuilder sb = new StringBuilder(length);-        for (int i = 0; i < length; i++) {-            sb.append(characters.charAt(random.nextInt(characters.length())));+    private static String getEnv(String key) {+        String value = System.getenv(key);+        if (null == value || value.isEmpty()) {+            throw new RuntimeException("value is null");         }-        return sb.toString();+        return value;     } }\ No newline at end of filediff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReviewBak.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReviewBak.javanew file mode 100644index 0000000..3267e77--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReviewBak.java@@ -0,0 +1,164 @@+package dkw.middleware.sdk;++import com.alibaba.fastjson2.JSON;+import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionRequestDTO;+import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionSyncResponseDTO;+import dkw.middleware.sdk.infrastructure.weixin.dto.TemplateMessageDTO;+import dkw.middleware.sdk.domain.model.Model;+import dkw.middleware.sdk.types.utils.BearerTokenUtils;+import dkw.middleware.sdk.types.utils.HttpUtils;+import dkw.middleware.sdk.types.utils.RandomStringUtils;+import dkw.middleware.sdk.types.utils.WXAccessTokenUtils;+import org.eclipse.jgit.api.Git;+import org.eclipse.jgit.transport.UsernamePasswordCredentialsProvider;++import java.io.*;+import java.net.HttpURLConnection;+import java.net.URL;+import java.nio.charset.StandardCharsets;+import java.text.SimpleDateFormat;+import java.util.ArrayList;+import java.util.Date;+++public class OpenAiCodeReviewBak {+    public static void main(String[] args) throws Exception {+        System.out.println("openai代码评审 测试执行");++        String token = System.getenv("GITHUB_TOKENS");+        if (null == token || token.isEmpty()) {+            throw new RuntimeException("token is null");+        }+        //代码检出+        ProcessBuilder processBuilder = new ProcessBuilder("git", "diff", "HEAD~1", "HEAD");++        Process process = processBuilder.start();++        BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(process.getInputStream()));+        String line;++        StringBuffer diffCode = new StringBuffer();+        while ((line = bufferedReader.readLine()) != null) {+            diffCode.append(line);+        }++        int exitCode = process.waitFor();+        System.out.println("exit code=" + exitCode);+        System.out.println("diff code=\r\n" + diffCode);++        //代码评审+        String log = codeReview(diffCode.toString());+        System.out.println("code review log:\r\n" + log);++        //写入日志+        String logUrl = writeLog(token, log, diffCode.toString());+        System.out.println("write log to:\r\n" + logUrl);++        //消息通知+        System.out.println("pushMessage：" + logUrl);+        pushMessage(logUrl);++    }++    private static void pushMessage(String logUrl) {+        String accessToken = WXAccessTokenUtils.getAccessToken();+        System.out.println(accessToken);++        TemplateMessageDTO templateMessage = new TemplateMessageDTO();+        templateMessage.put("project", "openai-code-review-9139-dkw");+        templateMessage.put("review", logUrl);+        templateMessage.setTemplateJumpUrl(logUrl);++        String url = String.format("https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=%s", accessToken);+        System.out.println(JSON.toJSONString(templateMessage));+        HttpUtils.sendPostRequest(url, JSON.toJSONString(templateMessage));+    }+++    private static String codeReview(String diffCode) throws Exception {+        String ak = "8751544afb8b574a2d3a717bed8bf86e.NR9C8vqi6DIhbSJh";+        String token = BearerTokenUtils.getToken(ak);++        URL url = new URL("https://open.bigmodel.cn/api/paas/v4/chat/completions");+        HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();++        httpURLConnection.setRequestMethod("POST");+        httpURLConnection.setRequestProperty("Authorization", "Bearer " + token);+        httpURLConnection.setRequestProperty("Content-Type", "application/json");+        httpURLConnection.setRequestProperty("User-Agent", "Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)");+        httpURLConnection.setDoOutput(true);++        ChatCompletionRequestDTO chatCompletionRequestDTO = new ChatCompletionRequestDTO();+        chatCompletionRequestDTO.setModel(Model.GLM_4_FLASH.getCode());+        chatCompletionRequestDTO.setMessages(new ArrayList<ChatCompletionRequestDTO.Prompt>() {+            private static final long serialVersionUID = -7988151926241837899L;++            {+                add(new ChatCompletionRequestDTO.Prompt("user", "你是一个高级编程架构师，精通各类场景方案、架构设计和编程语言请，请您根据git diff记录，对代码做出评审。代码如下:"));+                add(new ChatCompletionRequestDTO.Prompt("user", diffCode));+            }+        });++        try (OutputStream outputStream = httpURLConnection.getOutputStream()) {+            byte[] bytes = JSON.toJSONString(chatCompletionRequestDTO).getBytes(StandardCharsets.UTF_8);+            outputStream.write(bytes);+        }++        int responseCode = httpURLConnection.getResponseCode();+        System.out.println(responseCode);+        String responseMessage = httpURLConnection.getResponseMessage();+        System.out.println(responseMessage);++        BufferedReader in = new BufferedReader(new InputStreamReader(httpURLConnection.getInputStream()));+        String inputLine;++        StringBuffer content = new StringBuffer();+        while ((inputLine = in.readLine()) != null) {+            content.append(inputLine);+        }++        in.close();+        httpURLConnection.disconnect();++        System.out.println("评审结果：" + content.toString());+++        ChatCompletionSyncResponseDTO response = JSON.parseObject(content.toString(), ChatCompletionSyncResponseDTO.class);+        System.out.println(response.getChoices().get(0).getMessage().getContent());+        return response.getChoices().get(0).getMessage().getContent();+    }++    private static String writeLog(String token, String log, String diffCodeStr) throws Exception {++        Git gitRepo = Git.cloneRepository()+                .setURI("https://github.com/KeWen-Du/openai-code-review-log.git")+                .setDirectory(new File("repo"))+                .setCredentialsProvider(new UsernamePasswordCredentialsProvider(token, ""))+                .call();++        String dateFolderName = new SimpleDateFormat("yyyy-MM-dd").format(new Date());+        File dateFolder = new File("repo/" + dateFolderName);+        if (!dateFolder.exists()) {+            dateFolder.mkdirs();+        }+        String fileNameStr = RandomStringUtils.generateRandomString(12) + ".md";+        String fileNamePre = new SimpleDateFormat("HH_mm_ss").format(new Date());+        String fileName = fileNamePre + "_" + fileNameStr;+        File newFile = new File(dateFolder, fileName);++        try (FileWriter writer = new FileWriter(newFile)) {+            writer.write("### 代码变更记录 git diff\r\n");+            writer.write(diffCodeStr + "\r\n\r\n");+            writer.write(log);+        }++        gitRepo.add().addFilepattern(dateFolderName + "/" + fileName).call();+        gitRepo.commit().setMessage("Add new file via GitHub Actions").call();+        gitRepo.push().setCredentialsProvider(new UsernamePasswordCredentialsProvider(token, "")).call();++        System.out.println("Changes have been pushed to the repository.");++        return "https://github.com/KeWen-Du/openai-code-review-log/blob/master/" + dateFolderName + "/" + fileName;+    }++}\ No newline at end of filediff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/Message.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/Message.javadeleted file mode 100644index 289e005..0000000--- a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/Message.java+++ /dev/null@@ -1,55 +0,0 @@-package dkw.middleware.sdk.domain.model;--import java.util.HashMap;-import java.util.Map;--public class Message {--    private String touser = "oavof6xGr7jIjnJ6PkO_9TGKnHD0";-    private String template_id = "HRXwDS1fSLMFEYEUTxDMPNEyn0ES3iWIF71qu90eoZI";-    private String url = "https://weixin.qq.com";-    private Map<String, Map<String, String>> data = new HashMap<>();--    public void put(String key, String value) {-        data.put(key, new HashMap<String, String>() {-            private static final long serialVersionUID = 7092338402387318563L;--            {-                put("value", value);-            }-        });-    }--    public String getTouser() {-        return touser;-    }--    public void setTouser(String touser) {-        this.touser = touser;-    }--    public String getTemplate_id() {-        return template_id;-    }--    public void setTemplate_id(String template_id) {-        this.template_id = template_id;-    }--    public String getUrl() {-        return url;-    }--    public void setUrl(String url) {-        this.url = url;-    }--    public Map<String, Map<String, String>> getData() {-        return data;-    }--    public void setData(Map<String, Map<String, String>> data) {-        this.data = data;-    }--}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/AbstractOpenAiCodeReviewService.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/AbstractOpenAiCodeReviewService.javanew file mode 100644index 0000000..edead16--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/AbstractOpenAiCodeReviewService.java@@ -0,0 +1,49 @@+package dkw.middleware.sdk.domain.service;++import dkw.middleware.sdk.infrastructure.git.GitCommand;+import dkw.middleware.sdk.infrastructure.openai.IOpenAI;+import dkw.middleware.sdk.infrastructure.weixin.WeiXin;+import org.slf4j.Logger;+import org.slf4j.LoggerFactory;++import java.io.IOException;++public abstract class AbstractOpenAiCodeReviewService implements IOpenAiCodeReviewService {++    private final Logger logger = LoggerFactory.getLogger(AbstractOpenAiCodeReviewService.class);++    protected final GitCommand gitCommand;+    protected final IOpenAI openAI;+    protected final WeiXin weiXin;++    public AbstractOpenAiCodeReviewService(GitCommand gitCommand, IOpenAI openAI, WeiXin weiXin) {+        this.gitCommand = gitCommand;+        this.openAI = openAI;+        this.weiXin = weiXin;+    }++    @Override+    public void exec() {+        try {+            //1.获取提交代码+            String diffCode = getDiffCode();+            //2.开始评审代码+            String reviewResult = codeReview(diffCode);+            //3.记录评审结果 返回日志地址+            String logUrl = recordCodeReview(reviewResult, diffCode);+            //4.发送消息通知 日志地址 通知的内容+            pushMessage(logUrl);+        } catch (Exception e) {+            logger.error("openai-code-review error", e);+        }+    }++    protected abstract String getDiffCode() throws IOException, InterruptedException;++    protected abstract String codeReview(String diffCode) throws Exception;++    protected abstract String recordCodeReview(String reviewResult, String diffCode) throws Exception;++    protected abstract void pushMessage(String logUrl) throws Exception;++}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/IOpenAiCodeReviewService.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/IOpenAiCodeReviewService.javanew file mode 100644index 0000000..47fa54f--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/IOpenAiCodeReviewService.java@@ -0,0 +1,6 @@+package dkw.middleware.sdk.domain.service;++public interface IOpenAiCodeReviewService {++    void exec();+}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/impl/OpenAiCodeReviewService.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/impl/OpenAiCodeReviewService.javanew file mode 100644index 0000000..558915a--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/service/impl/OpenAiCodeReviewService.java@@ -0,0 +1,88 @@+package dkw.middleware.sdk.domain.service.impl;++import dkw.middleware.sdk.domain.model.Model;+import dkw.middleware.sdk.domain.service.AbstractOpenAiCodeReviewService;+import dkw.middleware.sdk.infrastructure.git.GitCommand;+import dkw.middleware.sdk.infrastructure.openai.IOpenAI;+import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionRequestDTO;+import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionSyncResponseDTO;+import dkw.middleware.sdk.infrastructure.weixin.WeiXin;+import dkw.middleware.sdk.infrastructure.weixin.dto.TemplateMessageDTO;++import java.io.IOException;+import java.util.ArrayList;+import java.util.HashMap;+import java.util.Map;++public class OpenAiCodeReviewService extends AbstractOpenAiCodeReviewService {++    public OpenAiCodeReviewService(GitCommand gitCommand, IOpenAI openAI, WeiXin weiXin) {+        super(gitCommand, openAI, weiXin);+    }++    @Override+    protected String getDiffCode() throws IOException, InterruptedException {+        return gitCommand.diff();+    }++    @Override+    protected String codeReview(String diffCode) throws Exception {+        ChatCompletionRequestDTO chatCompletionRequestDTO = new ChatCompletionRequestDTO();+        chatCompletionRequestDTO.setModel(Model.GLM_4_FLASH.getCode());+        chatCompletionRequestDTO.setMessages(new ArrayList<ChatCompletionRequestDTO.Prompt>() {+            private static final long serialVersionUID = -7988151926241837899L;++            {+//                add(new ChatCompletionRequestDTO.Prompt("user", "你是一个高级编程架构师，精通各类场景方案、架构设计和编程语言请，请您根据git diff记录，对代码做出评审。代码如下:"));+                add(new ChatCompletionRequestDTO.Prompt("user", "你是一位资深编程专家，拥有深厚的编程基础和广泛的技术栈知识。你的专长在于识别代码中的低效模式、安全隐患、以及可维护性问题，并能提出针对性的优化策略。你擅长以易于理解的方式解释复杂的概念，确保即使是初学者也能跟随你的指导进行有效改进。在提供优化建议时，你注重平衡性能、可读性、安全性、逻辑错误、异常处理、边界条件，以及可维护性方面的考量，同时尊重原始代码的设计意图。\n" ++                        "你总是以鼓励和建设性的方式提出反馈，致力于提升团队的整体编程水平，详尽指导编程实践，雕琢每一行代码至臻完善。用户会将仓库代码分支修改代码给你，以git diff 字符串的形式提供，你需要根据变化的代码，帮忙review本段代码。然后你review内容的返回内容必须严格遵守下面我给你的格式，包括标题内容。\n" ++                        "模板中的变量内容解释：\n" ++                        "变量1是给review打分，分数区间为0~100分。\n" ++                        "变量2 是code review发现的问题点，包括：可能的性能瓶颈、逻辑缺陷、潜在问题、安全风险、命名规范、注释、以及代码结构、异常情况、边界条件、资源的分配与释放等等\n" ++                        "变量3是具体的优化修改建议。\n" ++                        "变量4是你给出的修改后的代码。 \n" ++                        "变量5是代码中的优点。\n" ++                        "变量6是代码的逻辑和目的，识别其在特定上下文中的作用和限制\n" ++                        "\n" ++                        "必须要求：\n" ++                        "1. 以精炼的语言、严厉的语气指出存在的问题。\n" ++                        "2. 你的反馈内容必须使用严谨的markdown格式\n" ++                        "3. 不要携带变量内容解释信息。\n" ++                        "4. 有清晰的标题结构\n" ++                        "返回格式严格如下：\n" ++                        "# DKW项目： OpenAi 代码评审.\n" ++                        "### \uD83D\uDE00代码评分：{变量1}\n" ++                        "#### \uD83D\uDE00代码逻辑与目的：\n" ++                        "{变量6}\n" ++                        "#### ✅代码优点：\n" ++                        "{变量5}\n" ++                        "#### \uD83E\uDD14问题点：\n" ++                        "{变量2}\n" ++                        "#### \uD83C\uDFAF修改建议：\n" ++                        "{变量3}\n" ++                        "#### \uD83D\uDCBB修改后的代码：\n" ++                        "{变量4}\n" ++                        "`;代码如下:"));+                add(new ChatCompletionRequestDTO.Prompt("user", diffCode));+            }+        });++        ChatCompletionSyncResponseDTO completions = openAI.completions(chatCompletionRequestDTO);+        ChatCompletionSyncResponseDTO.Message message = completions.getChoices().get(0).getMessage();+        return message.getContent();+    }++    @Override+    protected String recordCodeReview(String reviewResult,String diffCode) throws Exception {+        return gitCommand.writeLog(reviewResult,diffCode);+    }++    @Override+    protected void pushMessage(String logUrl) throws Exception {+        Map<String, Map<String, String>> templateData = new HashMap<>();+        TemplateMessageDTO.put(templateData, TemplateMessageDTO.TemplateKey.REPO_NAME,gitCommand.getProject());+        TemplateMessageDTO.put(templateData, TemplateMessageDTO.TemplateKey.BRANCH_NAME,gitCommand.getBranch());+        TemplateMessageDTO.put(templateData, TemplateMessageDTO.TemplateKey.COMMIT_AUTHOR,gitCommand.getAuthor());+        TemplateMessageDTO.put(templateData, TemplateMessageDTO.TemplateKey.COMMIT_MESSAGE,gitCommand.getMessage());+    }+}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/git/GitCommand.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/git/GitCommand.javanew file mode 100644index 0000000..876cbed--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/git/GitCommand.java@@ -0,0 +1,134 @@+package dkw.middleware.sdk.infrastructure.git;+++import dkw.middleware.sdk.types.utils.RandomStringUtils;+import org.eclipse.jgit.api.Git;+import org.eclipse.jgit.transport.UsernamePasswordCredentialsProvider;+import org.slf4j.Logger;+import org.slf4j.LoggerFactory;++import java.io.*;+import java.text.SimpleDateFormat;+import java.util.Date;++public class GitCommand {++    private final Logger logger = LoggerFactory.getLogger(GitCommand.class);++    private final String githubReviewLogUri;+    private final String githubToken;+    private final String project;+    private final String branch;+    private final String author;+    private final String message;++    public GitCommand(String githubReviewLogUri, String githubToken, String project, String branch, String author, String message) {+        this.githubReviewLogUri = githubReviewLogUri;+        this.githubToken = githubToken;+        this.project = project;+        this.branch = branch;+        this.author = author;+        this.message = message;+    }++    public String getMessage() {+        return message;+    }++    public String getProject() {+        return project;+    }++    public String getBranch() {+        return branch;+    }++    public String getAuthor() {+        return author;+    }++    /**+     * 获取git diff+     * @return+     * @throws IOException+     * @throws InterruptedException+     */+    public String diff() throws IOException, InterruptedException {+        // 创建一个进程构建器，用于执行git命令，获取最新的提交哈希+        ProcessBuilder logProcessBuilder = new ProcessBuilder("git", "log", "-1", "--pretty=format:%H");+        // 设置git命令的执行目录为当前目录+        logProcessBuilder.directory(new File("."));+        // 启动进程以执行git命令+        Process logProcess = logProcessBuilder.start();++        // 读取进程的标准输出流+        BufferedReader logReader = new BufferedReader(new InputStreamReader(logProcess.getInputStream()));+        // 读取并保存最新的提交哈希+        String lastCommitHash = logReader.readLine();+        // 关闭输入流+        logReader.close();+        // 等待进程执行完毕+        logProcess.waitFor();+        logger.info("lastCommitHash:{}", lastCommitHash);+++        // 创建ProcessBuilder对象，用于执行git diff命令，获取最近一次提交的差异+        ProcessBuilder diffProcessBuilder = new ProcessBuilder("git", "diff", lastCommitHash+"^", lastCommitHash);+        // 设置ProcessBuilder的工作目录为当前目录+        diffProcessBuilder.directory(new File("."));+        // 启动进程+        Process diffProcess = diffProcessBuilder.start();++        // 创建StringBuilder对象，用于拼接差异内容+        StringBuilder diffCode = new StringBuilder();+        // 创建BufferedReader对象，用于读取进程的输出流+        BufferedReader diffReader = new BufferedReader(new InputStreamReader(diffProcess.getInputStream()));+        String line;+        // 循环读取每一行的输出，并拼接到diffCode中+        while ((line = diffReader.readLine()) != null) {+            diffCode.append(line).append("\r\n");+        }+        // 关闭输入流+        diffReader.close();+        // 等待进程结束，并获取退出码+        int exitCode = diffProcess.waitFor();+        // 如果退出码不为0，表示git diff命令执行失败+        if (exitCode!=0) {+            throw new RuntimeException("Failed to get diff, exit code:" + exitCode);+        }+        logger.info("diffCode:{}", diffCode);++        return diffCode.toString();+    }++    public String writeLog(String reviewResult, String diffCodeStr) throws Exception {++        Git gitRepo = Git.cloneRepository()+                .setURI(githubReviewLogUri+".git")+                .setDirectory(new File("repo"))+                .setCredentialsProvider(new UsernamePasswordCredentialsProvider(githubToken, ""))+                .call();++        String dateFolderName = new SimpleDateFormat("yyyy-MM-dd").format(new Date());+        File dateFolder = new File("repo/" + dateFolderName);+        if (!dateFolder.exists()) {+            dateFolder.mkdirs();+        }++        String fileName = project+"-"+branch+"-"+author+System.currentTimeMillis()+"-"+RandomStringUtils.generateRandomString(4);+        File newFile = new File(dateFolder, fileName);++        try (FileWriter writer = new FileWriter(newFile)) {+            writer.write("### 代码变更记录 git diff\r\n");+            writer.write(diffCodeStr + "\r\n\r\n");+            writer.write(reviewResult);+        }++        gitRepo.add().addFilepattern(dateFolderName + "/" + fileName).call();+        gitRepo.commit().setMessage("add code review new file" + fileName).call();+        gitRepo.push().setCredentialsProvider(new UsernamePasswordCredentialsProvider(githubToken, "")).call();++        logger.info("openai-code-review git commit and push done! {}", fileName);+        return githubReviewLogUri + "/blob/master/" + dateFolderName + "/" + fileName;+    }+}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/IOpenAI.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/IOpenAI.javanew file mode 100644index 0000000..22e857b--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/IOpenAI.java@@ -0,0 +1,9 @@+package dkw.middleware.sdk.infrastructure.openai;++import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionRequestDTO;+import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionSyncResponseDTO;++public interface IOpenAI {++    ChatCompletionSyncResponseDTO completions(ChatCompletionRequestDTO requestDTO) throws Exception;+}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/ChatCompletionRequest.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/dto/ChatCompletionRequestDTO.javasimilarity index 87%rename from openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/ChatCompletionRequest.javarename to openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/dto/ChatCompletionRequestDTO.javaindex a5fe579..a4f5af0 100644--- a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/ChatCompletionRequest.java+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/dto/ChatCompletionRequestDTO.java@@ -1,8 +1,10 @@-package dkw.middleware.sdk.domain.model;+package dkw.middleware.sdk.infrastructure.openai.dto;++import dkw.middleware.sdk.domain.model.Model;  import java.util.List; -public class ChatCompletionRequest {+public class ChatCompletionRequestDTO {      private String model = Model.GLM_4_FLASH.getCode();     private List<Prompt> messages;diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/ChatCompletionSyncResponse.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/dto/ChatCompletionSyncResponseDTO.javasimilarity index 90%rename from openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/ChatCompletionSyncResponse.javarename to openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/dto/ChatCompletionSyncResponseDTO.javaindex 9dc649b..ca6bdf9 100644--- a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/domain/model/ChatCompletionSyncResponse.java+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/dto/ChatCompletionSyncResponseDTO.java@@ -1,8 +1,8 @@-package dkw.middleware.sdk.domain.model;+package dkw.middleware.sdk.infrastructure.openai.dto;  import java.util.List; -public class ChatCompletionSyncResponse {+public class ChatCompletionSyncResponseDTO {      private List<Choice> choices; diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/impl/ChatGLM.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/impl/ChatGLM.javanew file mode 100644index 0000000..de1bdab--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/openai/impl/ChatGLM.java@@ -0,0 +1,70 @@+package dkw.middleware.sdk.infrastructure.openai.impl;++import com.alibaba.fastjson2.JSON;+import dkw.middleware.sdk.infrastructure.openai.IOpenAI;+import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionRequestDTO;+import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionSyncResponseDTO;+import dkw.middleware.sdk.types.utils.BearerTokenUtils;+import org.slf4j.Logger;+import org.slf4j.LoggerFactory;++import java.io.BufferedReader;+import java.io.InputStreamReader;+import java.io.OutputStream;+import java.net.HttpURLConnection;+import java.net.URL;+import java.nio.charset.StandardCharsets;++public class ChatGLM implements IOpenAI {++    private final Logger logger = LoggerFactory.getLogger(ChatGLM.class);++    private final String apiHost;+    private final String apiKeySecret;++    public ChatGLM(String apiHost, String apiKeySecret) {+        this.apiHost = apiHost;+        this.apiKeySecret = apiKeySecret;+    }++    @Override+    public ChatCompletionSyncResponseDTO completions(ChatCompletionRequestDTO requestDTO) throws Exception {+//        String ak = "8751544afb8b574a2d3a717bed8bf86e.NR9C8vqi6DIhbSJh";+//        URL url = new URL("https://open.bigmodel.cn/api/paas/v4/chat/completions");++        String chatGLMToken = BearerTokenUtils.getToken(apiKeySecret);+        URL url = new URL(apiHost);++        HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();+        httpURLConnection.setRequestMethod("POST");+        httpURLConnection.setRequestProperty("Authorization", "Bearer " + chatGLMToken);+        httpURLConnection.setRequestProperty("Content-Type", "application/json");+        httpURLConnection.setRequestProperty("User-Agent", "Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)");+        httpURLConnection.setDoOutput(true);++        try (OutputStream outputStream = httpURLConnection.getOutputStream()) {+            byte[] bytes = JSON.toJSONString(requestDTO).getBytes(StandardCharsets.UTF_8);+            outputStream.write(bytes);+        }++        int responseCode = httpURLConnection.getResponseCode();+        System.out.println(responseCode);+        String responseMessage = httpURLConnection.getResponseMessage();+        System.out.println(responseMessage);++        BufferedReader in = new BufferedReader(new InputStreamReader(httpURLConnection.getInputStream()));+        String inputLine;++        StringBuffer content = new StringBuffer();+        while ((inputLine = in.readLine()) != null) {+            content.append(inputLine);+        }++        in.close();+        httpURLConnection.disconnect();+        System.out.println("评审结果：" + content.toString());+++        return JSON.parseObject(content.toString(), ChatCompletionSyncResponseDTO.class);+    }+}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/weixin/WeiXin.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/weixin/WeiXin.javanew file mode 100644index 0000000..fb67d80--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/weixin/WeiXin.java@@ -0,0 +1,41 @@+package dkw.middleware.sdk.infrastructure.weixin;++import com.alibaba.fastjson2.JSON;+import dkw.middleware.sdk.infrastructure.weixin.dto.TemplateMessageDTO;+import dkw.middleware.sdk.types.utils.HttpUtils;+import dkw.middleware.sdk.types.utils.WXAccessTokenUtils;+import org.slf4j.Logger;+import org.slf4j.LoggerFactory;++import java.util.Map;++public class WeiXin {++    private final Logger logger = LoggerFactory.getLogger(WeiXin.class);++    private final String appid;+    private final String secret;+    private final String userWeixinToken;+    private final String template_id;++    public WeiXin(String appid, String secret, String userWeixinToken, String template_id) {+        this.appid = appid;+        this.secret = secret;+        this.userWeixinToken = userWeixinToken;+        this.template_id = template_id;+    }++    public void sendTemplateMessage(String logUrl, Map<String, Map<String,String>> data)throws Exception{+        String accessToken = WXAccessTokenUtils.getAccessToken(appid, secret);++        TemplateMessageDTO templateMessageDTO = new TemplateMessageDTO(userWeixinToken, template_id);+        templateMessageDTO.setTemplateJumpUrl(logUrl);+        templateMessageDTO.setTemplateData(data);+        templateMessageDTO.put("project", "openai-code-review-9139-dkw");+        templateMessageDTO.put("review", logUrl);++        String url = String.format("https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=%s", accessToken);+        System.out.println(JSON.toJSONString(templateMessageDTO));+        HttpUtils.sendPostRequest(url, JSON.toJSONString(templateMessageDTO));+    }+}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/weixin/dto/TemplateMessageDTO.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/weixin/dto/TemplateMessageDTO.javanew file mode 100644index 0000000..5a99bc8--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/infrastructure/weixin/dto/TemplateMessageDTO.java@@ -0,0 +1,94 @@+package dkw.middleware.sdk.infrastructure.weixin.dto;++import java.util.HashMap;+import java.util.Map;++public class TemplateMessageDTO {++    private String userWeixinToken = "oavof6xGr7jIjnJ6PkO_9TGKnHD0";+    private String template_id = "HRXwDS1fSLMFEYEUTxDMPNEyn0ES3iWIF71qu90eoZI";+    private String templateJumpUrl = "https://weixin.qq.com";+    private Map<String, Map<String, String>> templateData = new HashMap<>();++    public TemplateMessageDTO(String userWeixinToken, String template_id) {+        this.userWeixinToken = userWeixinToken;+        this.template_id = template_id;+    }++    public TemplateMessageDTO() {+    }++    public void put(String key, String value) {+        templateData.put(key, new HashMap<String, String>() {+            private static final long serialVersionUID = 7092338402387318563L;++            {+                put("value", value);+            }+        });+    }++    public static void put(Map<String,Map<String,String>> data,TemplateKey key,String value){+        data.put(key.getCode(), new HashMap<String, String>() {+            private static final long serialVersionUID = 7092338402387318563L;+            {+                put("value", value);+            }+        });+    }+    public enum TemplateKey{+        REPO_NAME("repo_name","项目名称"),+        BRANCH_NAME("branch_name","分支名称"),+        COMMIT_AUTHOR("commit_author","提交者"),+        COMMIT_MESSAGE("commit_message","提交信息"),+        ;+        private String code;+        private String desc;++        TemplateKey(String code, String desc) {+            this.code = code;+            this.desc = desc;+        }++        public String getCode() {+            return code;+        }++        public String getDesc() {+            return desc;+        }+    }++    public String getUserWeixinToken() {+        return userWeixinToken;+    }++    public void setUserWeixinToken(String userWeixinToken) {+        this.userWeixinToken = userWeixinToken;+    }++    public String getTemplate_id() {+        return template_id;+    }++    public void setTemplate_id(String template_id) {+        this.template_id = template_id;+    }++    public String getTemplateJumpUrl() {+        return templateJumpUrl;+    }++    public void setTemplateJumpUrl(String templateJumpUrl) {+        this.templateJumpUrl = templateJumpUrl;+    }++    public Map<String, Map<String, String>> getTemplateData() {+        return templateData;+    }++    public void setTemplateData(Map<String, Map<String, String>> templateData) {+        this.templateData = templateData;+    }++}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/HttpUtils.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/HttpUtils.javanew file mode 100644index 0000000..0f0d882--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/HttpUtils.java@@ -0,0 +1,33 @@+package dkw.middleware.sdk.types.utils;++import java.io.OutputStream;+import java.net.HttpURLConnection;+import java.net.URL;+import java.nio.charset.StandardCharsets;+import java.util.Scanner;++public class HttpUtils {++    public static void sendPostRequest(String urlString, String jsonBody) {+        try {+            URL url = new URL(urlString);+            HttpURLConnection conn = (HttpURLConnection) url.openConnection();+            conn.setRequestMethod("POST");+            conn.setRequestProperty("Content-Type", "application/json; utf-8");+            conn.setRequestProperty("Accept", "application/json");+            conn.setDoOutput(true);++            try (OutputStream os = conn.getOutputStream()) {+                byte[] input = jsonBody.getBytes(StandardCharsets.UTF_8);+                os.write(input, 0, input.length);+            }++            try (Scanner scanner = new Scanner(conn.getInputStream(), StandardCharsets.UTF_8.name())) {+                String response = scanner.useDelimiter("\\A").next();+                System.out.println(response);+            }+        } catch (Exception e) {+            e.printStackTrace();+        }+    }+}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/RandomStringUtils.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/RandomStringUtils.javanew file mode 100644index 0000000..f70d76c--- /dev/null+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/RandomStringUtils.java@@ -0,0 +1,21 @@+package dkw.middleware.sdk.types.utils;++import java.util.Random;++public class RandomStringUtils {+    /**+     * 生成指定长度随机字符串+     *+     * @param length+     * @return+     */+    public static String generateRandomString(int length) {+        String characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";+        Random random = new Random();+        StringBuilder sb = new StringBuilder(length);+        for (int i = 0; i < length; i++) {+            sb.append(characters.charAt(random.nextInt(characters.length())));+        }+        return sb.toString();+    }+}diff --git a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/WXAccessTokenUtils.java b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/WXAccessTokenUtils.javaindex a0161f3..8cd78a2 100644--- a/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/WXAccessTokenUtils.java+++ b/openai-code-review-sdk/src/main/java/dkw/middleware/sdk/types/utils/WXAccessTokenUtils.java@@ -15,6 +15,10 @@ public class WXAccessTokenUtils {     private static final String URL_TEMPLATE = "https://api.weixin.qq.com/cgi-bin/token?grant_type=%s&appid=%s&secret=%s";      public static String getAccessToken() {+        return getAccessToken(APPID,SECRET);+    }++    public static String getAccessToken(String APPID,String SECRET) {         try {             String urlString = String.format(URL_TEMPLATE, GRANT_TYPE, APPID, SECRET);             URL url = new URL(urlString);diff --git a/openai-code-review-sdk/src/main/resources/META-INF/MANIFEST.MF b/openai-code-review-sdk/src/main/resources/META-INF/MANIFEST.MFindex eec1864..62afbfb 100644--- a/openai-code-review-sdk/src/main/resources/META-INF/MANIFEST.MF+++ b/openai-code-review-sdk/src/main/resources/META-INF/MANIFEST.MF@@ -1,2 +1,2 @@ Manifest-Version: 1.0-Main-Class: dkw.middleware.sdk.OpenAiCodeReview+Main-Class: dkw.middleware.sdk.OpenAiCodeReviewBakdiff --git a/openai-code-review-sdk/src/test/java/dkw/middleware/sdk/test/ApiTest.java b/openai-code-review-sdk/src/test/java/dkw/middleware/sdk/test/ApiTest.javaindex 000ec92..0bac0d0 100644--- a/openai-code-review-sdk/src/test/java/dkw/middleware/sdk/test/ApiTest.java+++ b/openai-code-review-sdk/src/test/java/dkw/middleware/sdk/test/ApiTest.java@@ -1,8 +1,7 @@ package dkw.middleware.sdk.test;  import com.alibaba.fastjson2.JSON;-import com.alibaba.fastjson2.JSONObject;-import dkw.middleware.sdk.domain.model.ChatCompletionSyncResponse;+import dkw.middleware.sdk.infrastructure.openai.dto.ChatCompletionSyncResponseDTO; import dkw.middleware.sdk.types.utils.BearerTokenUtils; import dkw.middleware.sdk.types.utils.WXAccessTokenUtils; import org.junit.Test;@@ -74,7 +73,7 @@ public class ApiTest {         System.out.println(content.toString());  -        ChatCompletionSyncResponse response = JSON.parseObject(content.toString(), ChatCompletionSyncResponse.class);+        ChatCompletionSyncResponseDTO response = JSON.parseObject(content.toString(), ChatCompletionSyncResponseDTO.class);         System.out.println(response.getChoices().get(0).getMessage().getContent());     } 

根据提供的Git diff记录，以下是代码评审的总结：

### .github/workflows/main-maven-jar.yml
1. **新增环境变量获取**：新增了获取仓库名称、分支名称、提交作者和提交信息的步骤，这些信息将被用于后续的代码评审和日志记录。
2. **运行代码评审**：`Run Code Review`步骤现在包含了更多的环境变量，这些变量将被用于配置代码评审工具和发送通知。

### openai-code-review-sdk/pom.xml
1. **主类更改**：将`OpenAiCodeReview`更改为`OpenAiCodeReviewBak`，这可能是为了保留旧版本的同时引入新版本。

### openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReview.java
1. **代码重构**：大量代码被移除或重构，包括移除了`Message`类，增加了新的接口和实现类，如`GitCommand`、`IOpenAI`和`WeiXin`。
2. **日志记录**：引入了SLF4J日志记录器，用于记录操作过程中的重要信息。

### openai-code-review-sdk/src/main/java/dkw/middleware/sdk/OpenAiCodeReviewBak.java
1. **代码评审逻辑**：新的代码评审逻辑被实现，使用OpenAI和ChatGLM进行代码分析。
2. **异常处理**：增加了异常处理，确保在出现错误时能够优雅地处理。

### 其他文件
1. **新增类和接口**：新增了`AbstractOpenAiCodeReviewService`、`IOpenAiCodeReviewService`和`OpenAiCodeReviewService`等类和接口，用于实现代码评审的逻辑。
2. **DTO类**：新增了`ChatCompletionRequestDTO`、`ChatCompletionSyncResponseDTO`和`TemplateMessageDTO`等DTO类，用于处理API请求和响应。
3. **工具类**：新增了`HttpUtils`和`RandomStringUtils`等工具类，用于发送HTTP请求和生成随机字符串。

### 总结
这次代码更改主要是为了重构和优化代码评审流程。通过引入新的类和接口，代码变得更加模块化和可维护。此外，日志记录和异常处理也得到了加强，提高了代码的健壮性。

### 建议
1. **测试**：建议对新的代码进行充分的测试，以确保其稳定性和可靠性。
2. **文档**：更新项目文档，包括新的类、接口和方法的说明。
3. **代码风格**：确保代码风格的一致性，以提高代码的可读性。